<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FROM THE PLACE â€” TV</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=VT323&family=Share+Tech+Mono&family=Barlow+Condensed:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:         #0a0906;
  --surface:    #100e0b;
  --surface-2:  #161410;
  --border:     #201d16;
  --border-hi:  #322d20;
  --amber:      #c8943a;
  --amber-dim:  #4e380f;
  --amber-glow: rgba(200,148,58,0.11);
  --red:        #c03030;
  --red-dim:    #3d1010;
  --text:       #9a9080;
  --text-dim:   #3a3428;
  --text-hi:    #ddd0b4;
  --text-lo:    #221e16;
  --chan-w:     280px;
  --font-disp:  'VT323', monospace;
  --font-mono:  'Share Tech Mono', monospace;
  --font-cond:  'Barlow Condensed', sans-serif;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; background: var(--bg); color: var(--text); font-family: var(--font-mono); font-size: 13px; overflow: hidden; }

/* scanlines */
body::before {
  content: ''; position: fixed; inset: 0; z-index: 9000; pointer-events: none;
  background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.055) 2px, rgba(0,0,0,0.055) 4px);
}
/* grain */
body::after {
  content: ''; position: fixed; inset: 0; z-index: 9001; pointer-events: none; mix-blend-mode: overlay;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.78' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.045'/%3E%3C/svg%3E");
  background-size: 200px;
}

/* FLASH */
#flash {
  position: fixed; inset: 0; z-index: 8000;
  background: #000; opacity: 0; pointer-events: none; transition: opacity 0.07s;
}
#flash.on { opacity: 0.88; }
#static {
  position: fixed; inset: 0; z-index: 7999; pointer-events: none; opacity: 0; transition: opacity 0.05s;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.4'/%3E%3C/svg%3E");
  background-size: 200px; mix-blend-mode: screen;
}
#static.flash { opacity: 0.2; }

/* MASTHEAD */
#masthead {
  display: flex; align-items: stretch; height: 52px; flex-shrink: 0;
  border-bottom: 1px solid var(--border); background: var(--surface); position: relative; z-index: 100;
}
.mast-logo {
  display: flex; align-items: center; justify-content: center;
  padding: 6px 16px; border-right: 1px solid var(--border); flex-shrink: 0;
}
.mast-logo img { height: 34px; width: auto; display: block; filter: brightness(0.9) contrast(1.08); }
.mast-center { flex: 1; display: flex; align-items: center; justify-content: center; gap: 18px; }
.mast-on-air {
  display: flex; align-items: center; gap: 5px;
  padding: 2px 8px; border: 1px solid var(--red-dim); background: rgba(192,48,48,0.07);
}
.on-air-dot {
  width: 5px; height: 5px; border-radius: 50%; background: var(--red);
  animation: pulse 1.4s ease-in-out infinite;
}
@keyframes pulse {
  0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(192,48,48,0.5)}
  50%{opacity:0.5;box-shadow:0 0 0 5px rgba(192,48,48,0)}
}
.on-air-text { font-family: var(--font-mono); font-size: 8px; letter-spacing: 0.28em; color: var(--red); text-transform: uppercase; }
.mast-clock { font-family: var(--font-disp); font-size: 26px; color: var(--text-dim); letter-spacing: 0.1em; }
.mast-right { display: flex; align-items: center; gap: 10px; padding: 0 14px; border-left: 1px solid var(--border); flex-shrink: 0; }
.mast-btn {
  font-family: var(--font-mono); font-size: 8px; letter-spacing: 0.22em;
  color: var(--text-dim); text-transform: uppercase; text-decoration: none;
  transition: color 0.15s; cursor: pointer; background: none; border: none; padding: 0;
}
.mast-btn:hover { color: var(--amber); }

/* LAYOUT */
#layout {
  display: grid;
  grid-template-columns: 1fr var(--chan-w);
  height: calc(100vh - 52px);
}

/* â”€â”€ PLAYER ZONE â”€â”€ */
#player-zone {
  display: flex; flex-direction: column;
  border-right: 1px solid var(--border); overflow: hidden; background: #000;
  min-width: 0;
}

/*
  The YT player div MUST have real pixel dimensions when YT.Player() is called.
  Strategy: make #player-wrap a flex child that fills exactly a 16:9 slice of the column.
  We use aspect-ratio + max constraints so it never overflows.
  #yt-player is position:absolute inside it so it fills that real-pixel box.
*/
#player-clip {
  /* clips the player to the flex child's bounds */
  position: relative;
  width: 100%;
  flex-shrink: 0;
  overflow: hidden;
  background: #000;
}
#player-clip::before {
  /* 16:9 aspect ratio spacer */
  content: '';
  display: block;
  padding-top: 56.25%;
}
/* YT player â€” absolute fill, above placeholder */
#yt-player {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  width: 100%;
  height: 100%;
  z-index: 2;
}
/* YT injects an iframe; make sure it fills #yt-player */
#yt-player > iframe {
  position: absolute !important;
  top: 0 !important; left: 0 !important;
  width: 100% !important; height: 100% !important;
}

/* External channel iframe (NookTV etc) */
#ext-iframe {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  width: 100%; height: 100%; border: none;
  display: none;
  z-index: 2;
}

/* Placeholder â€” sits below video layers, shown only when no channel playing */
#player-placeholder {
  position: absolute; inset: 0; z-index: 1;
  display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px;
  background: #000;
}
#player-placeholder.hidden { display: none; }
.ph-num { font-family: var(--font-disp); font-size: 120px; color: #0d0b08; line-height: 1; letter-spacing: -5px; user-select: none; }
.ph-label { font-family: var(--font-mono); font-size: 9px; letter-spacing: 0.45em; color: var(--text-dim); text-transform: uppercase; }

/* CRT vignette over player */
#player-vignette {
  position: absolute; inset: 0; z-index: 4; pointer-events: none;
  background: radial-gradient(ellipse at center, transparent 50%, rgba(0,0,0,0.55) 100%);
}

/* TUNE-IN GATE â€” real click needed to unblock browser audio policy */
#tune-gate {
  position: absolute; inset: 0; z-index: 10;
  display: none;
  flex-direction: column; align-items: center; justify-content: center; gap: 10px;
  background: rgba(10,9,6,0.85);
  cursor: pointer;
}
#tune-gate.visible {
  display: flex;
  animation: gate-in 0.3s ease forwards;
}
@keyframes gate-in { from { opacity: 0; } to { opacity: 1; } }
.tg-ch {
  font-family: var(--font-disp); font-size: 80px;
  color: var(--text-lo); line-height: 1; letter-spacing: -4px; user-select: none;
}
.tg-name {
  font-family: var(--font-cond); font-weight: 700; font-size: 13px;
  letter-spacing: 0.12em; color: var(--text-dim); text-transform: uppercase;
}
.tg-cta {
  font-family: var(--font-mono); font-size: 8px;
  letter-spacing: 0.35em; color: var(--amber); text-transform: uppercase;
  border: 1px solid var(--amber-dim); padding: 6px 20px; margin-top: 6px;
  animation: tg-blink 2.2s step-end infinite;
}
@keyframes tg-blink { 0%,100%{opacity:1} 50%{opacity:0.2} }

/* CLIP PROGRESS */
#clip-bar-wrap { height: 2px; background: var(--border); flex-shrink: 0; }
#clip-bar { height: 100%; width: 0%; background: var(--amber); box-shadow: 0 0 8px rgba(200,148,58,0.35); transition: width 0.5s linear; }

/* NOW PLAYING BAR */
#now-playing {
  padding: 10px 16px; border-top: 1px solid var(--border);
  display: flex; align-items: center; gap: 12px;
  background: var(--surface); flex-shrink: 0;
}
.np-ch { font-family: var(--font-disp); font-size: 30px; color: var(--amber); min-width: 42px; letter-spacing: 0.05em; line-height: 1; }
.np-meta { flex: 1; min-width: 0; }
.np-title { font-family: var(--font-cond); font-weight: 700; font-size: 14px; color: var(--text-hi); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; letter-spacing: 0.04em; }
.np-sub { font-family: var(--font-mono); font-size: 9px; color: var(--text-dim); letter-spacing: 0.12em; margin-top: 2px; }
.live-badge {
  display: inline-flex; align-items: center; gap: 5px;
  background: var(--red); color: #fff;
  font-family: var(--font-mono); font-size: 8px;
  letter-spacing: 0.22em; padding: 2px 7px; text-transform: uppercase; flex-shrink: 0;
}
.live-badge::before { content: ''; width: 5px; height: 5px; border-radius: 50%; background: #fff; animation: blink 1.2s step-end infinite; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }
.live-badge.off { display: none; }

/* DESCRIPTION */
#player-desc { flex: 1; overflow-y: auto; padding: 12px 16px; border-top: 1px solid var(--border); scrollbar-width: thin; scrollbar-color: var(--border-hi) transparent; }
#player-desc::-webkit-scrollbar { width: 3px; }
#player-desc::-webkit-scrollbar-thumb { background: var(--border-hi); }
.desc-text { font-family: var(--font-mono); font-size: 11px; color: var(--text-dim); line-height: 1.75; letter-spacing: 0.03em; }

/* â”€â”€ CHANNEL GUIDE â”€â”€ */
#channel-guide { display: flex; flex-direction: column; background: var(--surface); overflow: hidden; }
.guide-head {
  padding: 9px 13px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
}
.guide-head-label { font-family: var(--font-mono); font-size: 8px; letter-spacing: 0.4em; color: var(--text-dim); text-transform: uppercase; }
.guide-head-count { font-family: var(--font-disp); font-size: 20px; color: var(--text-lo); }
#channel-list { flex: 1; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--border-hi) transparent; }
#channel-list::-webkit-scrollbar { width: 3px; }
#channel-list::-webkit-scrollbar-thumb { background: var(--border-hi); }

/* CHANNEL TILE */
.ch-tile {
  border-bottom: 1px solid var(--border);
  cursor: pointer; outline: none; user-select: none;
  border-left: 3px solid transparent;
  transition: background 0.1s, border-left-color 0.1s;
}
.ch-tile:hover  { background: var(--amber-glow); border-left-color: var(--amber-dim); }
.ch-tile:focus  { background: var(--amber-glow); border-left-color: var(--amber-dim); }
.ch-tile.active { background: rgba(200,148,58,0.09); border-left-color: var(--amber); }

/* thumb strip */
.ch-thumb {
  position: relative; width: 100%; padding-top: 38%; overflow: hidden; background: #000;
}
.ch-thumb-static {
  position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover;
  filter: sepia(0.5) brightness(0.6) contrast(1.1) saturate(0.7);
  opacity: 0; transition: opacity 0.3s;
}
.ch-thumb-static.loaded { opacity: 1; }
.ch-thumb-live {
  position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover;
  filter: brightness(0.88) contrast(1.04); opacity: 0; transition: opacity 0.3s;
}
.ch-tile:hover .ch-thumb-live.ready { opacity: 1; }
.ch-tile:hover .ch-thumb-static { opacity: 0; }
.ch-thumb-fb {
  position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
  background: linear-gradient(135deg, #080705 0%, #131109 100%);
}
.ch-thumb-fb-num { font-family: var(--font-disp); font-size: 38px; color: var(--text-lo); letter-spacing: -2px; line-height: 1; }
.ch-thumb::after {
  content: ''; position: absolute; inset: 0; pointer-events: none; z-index: 2;
  background: linear-gradient(0deg, rgba(10,9,6,0.84) 0%, transparent 60%);
}
.ch-live-dot {
  position: absolute; top: 5px; left: 6px; z-index: 3;
  display: flex; align-items: center; gap: 3px;
  background: rgba(192,48,48,0.85); padding: 1px 5px;
  font-family: var(--font-mono); font-size: 6px; letter-spacing: 0.2em; color: #fff; text-transform: uppercase;
}
.ch-live-dot::before { content: ''; width: 3px; height: 3px; border-radius: 50%; background: #fff; animation: blink 1.1s step-end infinite; }
.ch-live-dot.off { display: none; }
.ch-tile-np { position: absolute; bottom: 0; left: 0; right: 0; z-index: 3; padding: 4px 7px 5px; }
.ch-tile-np-label { font-family: var(--font-mono); font-size: 6px; letter-spacing: 0.25em; color: rgba(200,148,58,0.6); text-transform: uppercase; line-height: 1; margin-bottom: 1px; }
.ch-tile-np-text { font-family: var(--font-disp); font-size: 13px; color: rgba(240,232,216,0.88); letter-spacing: 0.03em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.1; }
.ch-tile-np-text.loading { color: rgba(255,255,255,0.15); font-size: 10px; letter-spacing: 0.18em; }

/* tile meta row */
.ch-meta {
  display: grid; grid-template-columns: 38px 1fr auto;
  align-items: center; gap: 0 7px; padding: 5px 9px 6px 0;
}
.ch-tile-num { font-family: var(--font-disp); font-size: 20px; color: var(--text-dim); text-align: right; line-height: 1; transition: color 0.1s; }
.ch-tile.active .ch-tile-num, .ch-tile:hover .ch-tile-num { color: var(--amber); }
.ch-tile-name { font-family: var(--font-cond); font-weight: 700; font-size: 11px; letter-spacing: 0.08em; color: var(--text-hi); text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.ch-tile-tag { font-family: var(--font-mono); font-size: 6px; letter-spacing: 0.15em; color: var(--amber-dim); border: 1px solid var(--border-hi); padding: 1px 4px; text-transform: uppercase; flex-shrink: 0; }

/* KBD HINT */
.kbd-hint { padding: 7px 12px; border-top: 1px solid var(--border); display: flex; gap: 10px; flex-shrink: 0; }
.kbd-hint span { font-size: 9px; color: var(--text-dim); letter-spacing: 0.08em; display: flex; align-items: center; gap: 4px; }
kbd { display: inline-block; border: 1px solid var(--border-hi); padding: 1px 4px; font-size: 8px; color: var(--text-dim); font-family: var(--font-mono); }

/* RESPONSIVE */
@media (max-width: 860px) {
  body { overflow: auto; }
  #layout { grid-template-columns: 1fr; grid-template-rows: auto auto; height: auto; }
  #player-zone { border-right: none; border-bottom: 1px solid var(--border); }
  #channel-guide { height: 380px; }
  #channel-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px,1fr)); }
}
</style>
</head>
<body>

<div id="flash"></div>
<div id="static"></div>

<!-- MASTHEAD -->
<header id="masthead">
  <div class="mast-logo">
    <img src="ftptv.png" alt="FTP TV">
  </div>
  <div class="mast-center">
    <div class="mast-on-air"><div class="on-air-dot"></div><div class="on-air-text">Broadcasting</div></div>
    <div class="mast-clock" id="clock">00:00:00</div>
  </div>
  <div class="mast-right">
    <button class="mast-btn" id="mute-btn" onclick="toggleMute()">ðŸ”‡ MUTE</button>
    <button class="mast-btn" onclick="toggleFullscreen()">â›¶ FULL</button>
  </div>
</header>

<div id="layout">

  <!-- PLAYER ZONE -->
  <section id="player-zone">
    <div id="player-clip">
      <!-- YT API replaces this div with an iframe.
           The div is position:absolute so it has real pixel dimensions. -->
      <div id="yt-player"></div>
      <iframe id="ext-iframe" frameborder="0" allow="autoplay; fullscreen" allowfullscreen></iframe>
      <div id="player-vignette"></div>

      <!-- Tune-in gate â€” requires real click to satisfy browser autoplay policy -->
      <div id="tune-gate" onclick="tuneIn()">
        <div class="tg-ch" id="tg-ch">01</div>
        <div class="tg-name" id="tg-name">FTP LIVE</div>
        <div class="tg-cta">Click to tune in</div>
      </div>
      <div id="player-placeholder" class="hidden">
        <div class="ph-num" id="ph-num">01</div>
        <div class="ph-label">Select a channel</div>
      </div>
    </div>

    <div id="clip-bar-wrap"><div id="clip-bar"></div></div>

    <div id="now-playing">
      <div class="np-ch" id="np-ch">â€”</div>
      <div class="np-meta">
        <div class="np-title" id="np-title">No signal</div>
        <div class="np-sub"   id="np-sub">Select a channel to begin</div>
      </div>
      <div class="live-badge off" id="live-badge">LIVE</div>
    </div>

    <div id="player-desc">
      <p class="desc-text" id="desc-text">Use the channel guide on the right. Arrow keys navigate, Enter selects.</p>
    </div>
  </section>

  <!-- CHANNEL GUIDE -->
  <aside id="channel-guide">
    <div class="guide-head">
      <span class="guide-head-label">Channel Guide</span>
      <span class="guide-head-count" id="guide-count">â€”</span>
    </div>
    <div id="channel-list" role="listbox"></div>
    <div class="kbd-hint">
      <span><kbd>â†‘â†“</kbd> Navigate</span>
      <span><kbd>â†µ</kbd> Tune</span>
      <span><kbd>M</kbd> Mute</span>
    </div>
  </aside>

</div>

<script src="FTP_MEGA.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHANNEL DATA
//
//  type 'ftpengine'  â€” FTP live broadcast. Uses wall-clock engine + YT player.
//  type 'iframe'     â€” Embed any URL (e.g. NookTV).
//  type 'placeholder'â€” No playback, shows description only.
//
//  thumb   â€” custom image (URL or local path). Priority over thumbId.
//  thumbId â€” YT video ID for static cover + hover live frame.
//
//  nowPlaying:
//    { type:'ftpengine', playlist }  â€” derive from local playlist
//    { type:'fetchjs', url, varName} â€” fetch remote *_MEGA.js and compute
//    { type:'static', text }         â€” fixed string
//    null                            â€” nothing shown
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CHANNELS = [
  {
    num:     1,
    name:    'FTP LIVE',
    tag:     'LIVE BROADCAST',
    desc:    'ÅŒtepoti Music Television â€” continuous live stream',
    live:    true,
    type:    'ftpengine',
    thumb:   null,
    thumbId: null,
    nowPlaying: { type: 'ftpengine', playlist: null },
  },
  {
    num:     2,
    name:    'NOOK & CRANNY',
    tag:     'LIVE',
    desc:    'Nook & Cranny TV â€” ÅŒtepoti',
    live:    true,
    type:    'iframe',
    src:     'https://fromtheplace.github.io/nooktv/',
    thumb:   null,
    thumbId: null,
    nowPlaying: { type: 'fetchjs', url: 'https://fromtheplace.github.io/nooktv/NOOK_MEGA.js', varName: 'videoPlaylist' },
  },
  {
    num:     3,
    name:    'FTPtv2',
    tag:     'ARCHIVE',
    desc:    'Full sets',
    live:    true,
    type:    'iframe',
    src:     'https://fromtheplace.github.io/ftptv/',
    thumb:   null,
    thumbId: null,
    nowPlaying: { type: 'fetchjs', url: 'https://fromtheplace.github.io/ftptv/FTP_MEGA.js', varName: 'videoPlaylist' },
  },
];

// Wire CH1 playlist
CHANNELS[0].nowPlaying.playlist = videoPlaylist;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FTP LIVE ENGINE  â€” copied verbatim from channel.html (proven working)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PLAYLIST      = videoPlaylist;
const TOTAL_SECONDS = PLAYLIST.reduce((s,t) => s + Math.max(0, t.end - t.start), 0);

function getLivePosition() {
  const nowSec    = Math.floor(Date.now() / 1000);
  const dayNumber = Math.floor(nowSec / 86400);
  const dailySeed = Number((BigInt(dayNumber % TOTAL_SECONDS) * 3571n) % BigInt(TOTAL_SECONDS));
  const posInCycle = ((nowSec % TOTAL_SECONDS) + dailySeed) % TOTAL_SECONDS;
  let elapsed = 0;
  for (let i = 0; i < PLAYLIST.length; i++) {
    const clipLen = PLAYLIST[i].end - PLAYLIST[i].start;
    if (posInCycle < elapsed + clipLen) return { index: i, seekOffset: posInCycle - elapsed };
    elapsed += clipLen;
  }
  return { index: 0, seekOffset: 0 };
}

function getLivePositionFor(playlist) {
  const total = playlist.reduce((s,t) => s + Math.max(0, t.end - t.start), 0);
  if (!total) return { index: 0, seekOffset: 0 };
  const nowSec    = Math.floor(Date.now() / 1000);
  const dayNumber = Math.floor(nowSec / 86400);
  const dailySeed = Number((BigInt(dayNumber % total) * 3571n) % BigInt(total));
  const posInCycle = ((nowSec % total) + dailySeed) % total;
  let elapsed = 0;
  for (let i = 0; i < playlist.length; i++) {
    const clipLen = playlist[i].end - playlist[i].start;
    if (posInCycle < elapsed + clipLen) return { index: i, seekOffset: posInCycle - elapsed };
    elapsed += clipLen;
  }
  return { index: 0, seekOffset: 0 };
}

function parseTitle(title) {
  const sep   = title.includes('â€”') ? 'â€”' : ' - ';
  const parts = title.split(sep);
  return { artist: parts[0].trim(), context: parts.slice(1).join(sep).replace(/\[.*?\]/g,'').replace(/#\w+/g,'').trim() };
}

// YT player state
let player = null, playerReady = false, hasTunedIn = false;
let _muted = true, progressTimer = null;
let videoIndex = 0, clipDuration = 0, clipEndAt = 0, pendingSeek = null, advancing = false;

function fmt(s) { s=Math.max(0,Math.floor(s)); return `${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`; }

// Boot YT API
(function(){ const t=document.createElement('script'); t.src='https://www.youtube.com/iframe_api'; document.head.appendChild(t); })();

window.onYouTubeIframeAPIReady = function() {
  player = new YT.Player('yt-player', {
    width: '100%', height: '100%',
    playerVars: { autoplay:0, mute:1, controls:0, disablekb:1, modestbranding:1, rel:0, iv_load_policy:3, fs:0, playsinline:1 },
    events: { onReady: onPlayerReady, onStateChange: onStateChange, onError: onError }
  });
};

function onPlayerReady() {
  playerReady = true;
  // Auto-tune fired before API ready â€” load the track now (still muted, gate visible)
  if (activeCh?.type === 'ftpengine') syncToLive();
}

// Called by clicking the tune-gate overlay â€” the only place audio is unlocked.
// Browser requires a direct user gesture on the page to allow audio.
function tuneIn() {
  hideTuneGate();

  if (activeCh?.type === 'ftpengine') {
    if (!playerReady || !player) return;
    hasTunedIn = true;
    player.unMute();
    player.setVolume(80);
    _muted = false;
    document.getElementById('mute-btn').textContent = 'ðŸ”Š MUTE';
    const state = player.getPlayerState();
    if (state === YT.PlayerState.CUED || state === YT.PlayerState.PAUSED || state === -1) {
      player.playVideo();
    }
  }
  else if (activeCh?.type === 'iframe') {
    showIframe(activeCh.src);
  }
}

function showTuneGate(ch) {
  document.getElementById('tg-ch').textContent   = String(ch.num).padStart(2,'0');
  document.getElementById('tg-name').textContent = ch.name;
  document.getElementById('tune-gate').classList.add('visible');
}
function hideTuneGate() {
  document.getElementById('tune-gate').classList.remove('visible');
}

function syncToLive() {
  const { index, seekOffset } = getLivePosition();
  videoIndex = index;
  loadTrack(index, seekOffset);
}

function loadTrack(index, seekOffset) {
  if (!playerReady || !player || !PLAYLIST.length) return;
  const track = PLAYLIST[index]; if (!track) return;
  advancing = false; clearInterval(progressTimer);
  clipDuration = track.end - track.start;
  const startAt = track.start + (seekOffset || 0);
  clipEndAt = track.end; pendingSeek = startAt;
  player.cueVideoById({ videoId: track.id, startSeconds: startAt, endSeconds: track.end });
  updateNowPlaying(track);
}

function onStateChange(e) {
  const S = YT.PlayerState;
  if (e.data === S.CUED) {
    if (pendingSeek !== null) { player.seekTo(pendingSeek, true); pendingSeek = null; }
    // Only auto-play if user has already clicked tune-in (audio unlocked)
    if (hasTunedIn) player.playVideo();
  }
  if (e.data === S.BUFFERING) {
    if (pendingSeek !== null) { player.seekTo(pendingSeek, true); pendingSeek = null; }
  }
  if (e.data === S.PLAYING) {
    if (pendingSeek !== null) {
      const t = pendingSeek; pendingSeek = null;
      if (Math.abs(player.getCurrentTime() - t) > 2) player.seekTo(t, true);
    }
    startProgress();
  }
  if (e.data === S.PAUSED) { clearInterval(progressTimer); }
  if (e.data === S.ENDED)  { clearInterval(progressTimer); advance(); }
}
function onError(e) { console.warn('YT error', e.data); advance(); }

function advance() {
  if (advancing) return; advancing = true; clearInterval(progressTimer);
  doStatic();
  setTimeout(() => { syncToLive(); }, 650);
}

function startProgress() {
  clearInterval(progressTimer);
  progressTimer = setInterval(() => {
    if (!player || !playerReady) return;
    const cur   = player.getCurrentTime();
    const track = PLAYLIST[videoIndex]; if (!track) return;
    const elapsed = Math.max(0, cur - track.start);
    const pct     = clipDuration > 0 ? Math.min(100, (elapsed / clipDuration) * 100) : 0;
    document.getElementById('clip-bar').style.width = pct.toFixed(1) + '%';
    if (clipEndAt > 0 && cur >= clipEndAt - 0.5 && !advancing) advance();
  }, 500);
}

function updateNowPlaying(track) {
  const p = parseTitle(track.title);
  setNpBar(String(activeCh.num).padStart(2,'0'), p.artist, p.context || activeCh.name, true, activeCh.desc);
  setTileNp(activeCh.num, p.artist + (p.context ? ' â€” ' + p.context : ''));
  setTileLiveId(activeCh.num, track.id);
}

function unmute() {
  if (!player) return;
  player.unMute(); player.setVolume(80); _muted = false;
  document.getElementById('mute-btn').textContent = 'ðŸ”Š MUTE';
}
function toggleMute() {
  if (!player) return;
  if (_muted) { unmute(); }
  else { player.mute(); _muted = true; document.getElementById('mute-btn').textContent = 'ðŸ”‡ MUTE'; }
}
function toggleFullscreen() {
  if (!document.fullscreenElement) document.documentElement.requestFullscreen();
  else document.exitFullscreen();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REMOTE PLAYLIST FETCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _plCache = {};
async function fetchRemotePlaylist(url, varName) {
  if (_plCache[url]) return _plCache[url];
  try {
    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const text = await res.text();
    const fn   = new Function(`${text}; return typeof ${varName}!=='undefined'?${varName}:null;`);
    const arr  = fn();
    if (!Array.isArray(arr) || !arr.length) throw new Error('empty');
    _plCache[url] = arr;
    return arr;
  } catch(e) { console.warn('[portal] fetchRemotePlaylist', url, e.message); return null; }
}

async function resolveNowPlaying(ch) {
  const np = ch.nowPlaying;
  if (!np) return null;
  if (np.type === 'ftpengine') {
    const pl = np.playlist; if (!pl?.length) return null;
    const { index } = getLivePositionFor(pl);
    const track = pl[index]; if (!track) return null;
    const p = parseTitle(track.title);
    return { text: p.artist + (p.context ? ' â€” ' + p.context : ''), videoId: track.id };
  }
  if (np.type === 'fetchjs') {
    const pl = await fetchRemotePlaylist(np.url, np.varName || 'videoPlaylist');
    if (!pl) return null;
    const { index } = getLivePositionFor(pl);
    const track = pl[index]; if (!track) return null;
    const p = parseTitle(track.title);
    return { text: p.artist + (p.context ? ' â€” ' + p.context : ''), videoId: track.id };
  }
  if (np.type === 'static') return { text: np.text, videoId: null };
  return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THUMBNAILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ytThumb(id, q) { return `https://i.ytimg.com/vi/${id}/${q}.jpg`; }
function loadYtThumb(img, videoId, cb) {
  img.onerror = () => { img.onerror = () => { cb&&cb(false); }; img.src = ytThumb(videoId,'hqdefault'); };
  img.onload  = () => { cb&&cb(true); };
  img.src     = ytThumb(videoId,'maxresdefault');
}

// tile data registry
const tileReg = {}; // ch.num â†’ { tile, staticImg, liveImg, fb, npEl, liveVideoId, liveLoaded }

function setTileNp(num, text) {
  const d = tileReg[num]; if (!d) return;
  d.npEl.textContent = text; d.npEl.classList.remove('loading');
}
function setTileLiveId(num, videoId) {
  const d = tileReg[num]; if (!d || !videoId) return;
  d.liveVideoId = videoId;
  // re-trigger live load if already hovered
  if (d.liveLoaded) { loadYtThumb(d.liveImg, videoId, ok => { if(ok) d.liveImg.classList.add('ready'); }); }
  // update static for live channels
  const ch = CHANNELS.find(c => c.num === num);
  if (ch?.live && d.staticImg) d.staticImg.src = ytThumb(videoId,'hqdefault');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BUILD GUIDE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildGuide() {
  const list = document.getElementById('channel-list');
  document.getElementById('guide-count').textContent = CHANNELS.length + ' ch';

  CHANNELS.forEach((ch, i) => {
    const staticSrc = ch.thumb || (ch.thumbId ? ytThumb(ch.thumbId,'hqdefault') : null);

    const tile = document.createElement('div');
    tile.className = 'ch-tile';
    tile.setAttribute('role','option');
    tile.setAttribute('tabindex', i===0?'0':'-1');
    tile.dataset.index = i;

    tile.innerHTML = `
      <div class="ch-thumb">
        ${staticSrc ? `<img class="ch-thumb-static" alt="${ch.name}" loading="lazy">` : ''}
        <img class="ch-thumb-live" alt="" aria-hidden="true">
        <div class="ch-thumb-fb"${staticSrc?' style="display:none"':''}>
          <div class="ch-thumb-fb-num">${String(ch.num).padStart(2,'0')}</div>
        </div>
        <div class="ch-live-dot${ch.live?'':' off'}">LIVE</div>
        <div class="ch-tile-np">
          <div class="ch-tile-np-label">Now Playing</div>
          <div class="ch-tile-np-text loading" data-np>Â·Â·Â·</div>
        </div>
      </div>
      <div class="ch-meta">
        <div class="ch-tile-num">${String(ch.num).padStart(2,'0')}</div>
        <div class="ch-tile-name">${ch.name}</div>
        ${ch.tag?`<div class="ch-tile-tag">${ch.tag}</div>`:''}
      </div>
    `;

    const staticImg = tile.querySelector('.ch-thumb-static');
    const liveImg   = tile.querySelector('.ch-thumb-live');
    const fb        = tile.querySelector('.ch-thumb-fb');
    const npEl      = tile.querySelector('[data-np]');
    let liveVideoId = ch.thumbId;
    let liveLoaded  = false;

    if (staticImg) {
      staticImg.addEventListener('error', () => { staticImg.style.display='none'; fb.style.display=''; });
      staticImg.addEventListener('load',  () => staticImg.classList.add('loaded'));
      staticImg.src = staticSrc;
    }

    tile.addEventListener('mouseenter', () => {
      if (liveLoaded || !liveVideoId) return;
      liveLoaded = true;
      loadYtThumb(liveImg, liveVideoId, ok => { if(ok) liveImg.classList.add('ready'); });
    });
    tile.addEventListener('click',   () => tuneToIndex(i));
    tile.addEventListener('keydown', e  => handleKey(e, i));

    list.appendChild(tile);
    tileReg[ch.num] = { tile, staticImg, liveImg, fb, npEl, liveVideoId, liveLoaded };

    // Resolve now-playing async
    resolveNowPlaying(ch).then(r => {
      if (r?.text) { npEl.textContent=r.text; npEl.classList.remove('loading'); }
      else { npEl.textContent='â€”'; npEl.classList.remove('loading'); }
      if (r?.videoId) { tileReg[ch.num].liveVideoId=r.videoId; if(ch.live&&staticImg) staticImg.src=ytThumb(r.videoId,'hqdefault'); }
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TUNE TO CHANNEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let activeIndex = -1;
let activeCh    = null;

function tuneToIndex(i) {
  const ch = CHANNELS[i]; if (!ch) return;

  doFlash(() => {
    // update tile highlights
    document.querySelectorAll('.ch-tile').forEach((t,idx) => t.classList.toggle('active', idx===i));
    activeIndex = i; activeCh = ch;

    // reset clip bar
    document.getElementById('clip-bar').style.width = '0%';

    if (ch.type === 'ftpengine') {
      showYT();
      showTuneGate(ch);
      if (playerReady) syncToLive();
    }
    else if (ch.type === 'iframe' && ch.src) {
      // Show gate first â€” clicking loads the iframe (avoids autoplaying embedded audio)
      showYT(); // hide placeholder, keep yt-player div present but will hide after click
      showTuneGate(ch);
      setNpBar(String(ch.num).padStart(2,'0'), ch.name, 'LIVE', ch.live, ch.desc);
      resolveNowPlaying(ch).then(r => { if(r?.text) setNpBar(String(ch.num).padStart(2,'0'), r.text, ch.name, ch.live, ch.desc); });
    }
    else {
      showPlaceholder(ch);
      setNpBar(String(ch.num).padStart(2,'0'), ch.name, ch.live?'LIVE':'ARCHIVE', ch.live, ch.desc);
    }
  });
}

function showYT() {
  document.getElementById('player-placeholder').classList.add('hidden');
  document.getElementById('yt-player').style.display = '';
  document.getElementById('ext-iframe').src = 'about:blank';
  document.getElementById('ext-iframe').style.display = 'none';
}
function showIframe(src) {
  document.getElementById('player-placeholder').classList.add('hidden');
  document.getElementById('yt-player').style.display = 'none';
  if (player && playerReady) { try { player.stopVideo(); } catch(e){} clearInterval(progressTimer); }
  const f = document.getElementById('ext-iframe');
  f.style.display = ''; f.src = src;
}
function showPlaceholder(ch) {
  hideTuneGate();
  if (player && playerReady) { try { player.stopVideo(); } catch(e){} clearInterval(progressTimer); }
  document.getElementById('yt-player').style.display = 'none';
  document.getElementById('ext-iframe').src = 'about:blank';
  document.getElementById('ext-iframe').style.display = 'none';
  document.getElementById('player-placeholder').classList.remove('hidden');
  document.getElementById('ph-num').textContent = String(ch.num).padStart(2,'0');
}

function setNpBar(ch, title, sub, live, desc) {
  document.getElementById('np-ch').textContent    = ch;
  document.getElementById('np-title').textContent = title;
  document.getElementById('np-sub').textContent   = sub;
  document.getElementById('live-badge').classList.toggle('off', !live);
  document.getElementById('desc-text').textContent = desc || '';
}

function doFlash(cb) {
  const f = document.getElementById('flash');
  f.classList.add('on'); doStatic();
  setTimeout(() => { f.classList.remove('on'); cb&&cb(); }, 85);
}
function doStatic() {
  const s = document.getElementById('static');
  s.classList.add('flash'); setTimeout(()=>s.classList.remove('flash'), 90);
}

// â”€â”€ KEYBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let focusIndex = 0;
function handleKey(e, i) {
  const tiles = document.querySelectorAll('.ch-tile');
  if (e.key==='ArrowDown')  { e.preventDefault(); focusIndex=Math.min(i+1,tiles.length-1); moveFocus(tiles); }
  if (e.key==='ArrowUp')    { e.preventDefault(); focusIndex=Math.max(i-1,0); moveFocus(tiles); }
  if (e.key==='Enter'||e.key===' ') { e.preventDefault(); tuneToIndex(i); }
}
function moveFocus(tiles) {
  tiles.forEach((t,i)=>t.setAttribute('tabindex',i===focusIndex?'0':'-1'));
  tiles[focusIndex].focus(); tiles[focusIndex].scrollIntoView({block:'nearest'});
}
document.addEventListener('keydown', e => {
  if (document.activeElement?.classList.contains('ch-tile')) return;
  if (e.key==='m'||e.key==='M') { toggleMute(); return; }
  const tiles = document.querySelectorAll('.ch-tile');
  if (e.key==='ArrowDown'||e.key==='ArrowRight') { e.preventDefault(); const n=activeIndex<CHANNELS.length-1?activeIndex+1:0; tuneToIndex(n); focusIndex=n; moveFocus(tiles); }
  if (e.key==='ArrowUp'||e.key==='ArrowLeft')    { e.preventDefault(); const p=activeIndex>0?activeIndex-1:CHANNELS.length-1; tuneToIndex(p); focusIndex=p; moveFocus(tiles); }
});

// â”€â”€ CLOCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tick() {
  const n = new Date();
  document.getElementById('clock').textContent =
    [n.getHours(),n.getMinutes(),n.getSeconds()].map(x=>String(x).padStart(2,'0')).join(':');
}
setInterval(tick,1000); tick();

// Refresh now-playing tiles every 60s
setInterval(() => {
  CHANNELS.forEach(ch => {
    const d = tileReg[ch.num]; if(!d) return;
    resolveNowPlaying(ch).then(r => {
      if(r?.text) { d.npEl.textContent=r.text; d.npEl.classList.remove('loading'); }
      if(r?.videoId) setTileLiveId(ch.num, r.videoId);
    });
  });
  // also refresh np bar if on live channel
  if (activeCh?.type==='ftpengine' && playerReady) {
    const track = PLAYLIST[videoIndex];
    if(track) updateNowPlaying(track);
  }
}, 60_000);

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
buildGuide();
// Auto-tune CH1 after short delay (lets YT API start loading in parallel)
setTimeout(() => {
  tuneToIndex(0);
  const tiles = document.querySelectorAll('.ch-tile');
  if (tiles[0]) { tiles[0].focus(); focusIndex=0; }
}, 300);
</script>
</body>
</html>
